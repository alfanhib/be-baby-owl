# Module 1: Authentication & Security

**Module ID:** M01  
**Module Name:** Authentication & Security  
**Priority:** üî¥ Critical (Phase 1, Sprint 1-2)  
**Story Points:** 42 points  
**Owner:** Backend Team + Frontend Team

---

## üìã Module Overview

### Purpose

This module provides the **foundation security layer** for the entire LMS Baby Owl platform. It handles user authentication (login/logout), session management, password management (forgot/reset/change), and role-based access control (RBAC) to ensure only authorized users can access specific features.

### Business Value

- **Security:** Protect user data and prevent unauthorized access
- **Compliance:** Meet data protection standards (GDPR-like for Indonesia)
- **User Trust:** Secure authentication builds user confidence
- **Foundation:** Required for all other modules to function

### Success Metrics

- Login success rate: >99%
- Session hijacking incidents: 0
- Password reset completion: >80%
- Failed login attempts blocked: 100% (after 5 attempts)

---

## üë• User Roles

- **Student:** Can login, change password, reset password
- **Instructor:** Can login, change password, reset password
- **Admin:** Can login, change password, reset password, manage user access

---

## üìö User Stories

### Story 1.1.1: User Login (Email + Password)

**Story Points:** 5  
**Priority:** üî¥ Critical  
**Sprint:** Sprint 1

#### User Story

```
AS A registered user (Student/Instructor/Admin)
I WANT TO login using my email and password
SO THAT I can access my account and use the LMS
```

#### Acceptance Criteria

**AC1: Login Form Display**

- GIVEN I am on the login page
- WHEN the page loads
- THEN I should see:
  - Email input field (type: email)
  - Password input field (type: password, masked)
  - "Show/Hide Password" toggle button
  - "Remember Me" checkbox
  - "Forgot Password?" link
  - "Login" button (primary CTA)
  - "Don't have an account? Sign Up" link
  - Logo and branding elements

**AC2: Successful Login (Credentials Valid)**

- GIVEN I have entered valid email and password
- WHEN I click "Login" button
- THEN:
  - API call to `/api/auth/login` with credentials
  - JWT token received and stored (localStorage or httpOnly cookie)
  - User object stored in state (Zustand)
  - Redirected to appropriate dashboard based on role:
    - Student ‚Üí `/student/dashboard`
    - Instructor ‚Üí `/instructor/dashboard`
    - Admin ‚Üí `/admin/dashboard`
  - Success toast notification: "Welcome back, [Name]!"

**AC3: Failed Login (Invalid Credentials)**

- GIVEN I have entered invalid email or password
- WHEN I click "Login" button
- THEN:
  - API returns 401 Unauthorized
  - Error message displayed: "Invalid email or password"
  - Password field cleared
  - Email field retains value
  - Login button re-enabled after 1 second

**AC4: Failed Login (User Not Found)**

- GIVEN I have entered an email that doesn't exist
- WHEN I click "Login" button
- THEN:
  - API returns 404 Not Found
  - Generic error message: "Invalid email or password" (security: don't reveal user existence)
  - Same behavior as AC3

**AC5: Form Validation (Client-Side)**

- GIVEN I am on the login page
- WHEN I attempt to login with invalid inputs
- THEN I should see validation errors:
  - Email empty: "Email is required"
  - Email invalid format: "Please enter a valid email"
  - Password empty: "Password is required"
  - Password too short (<8 chars): "Password must be at least 8 characters"

**AC6: Remember Me Functionality**

- GIVEN I check "Remember Me" checkbox
- WHEN I successfully login
- THEN:
  - JWT token stored in localStorage (longer expiry: 30 days)
  - On next visit, user auto-logged in (token still valid)

**AC7: Auto-Login (Existing Session)**

- GIVEN I have a valid JWT token in localStorage
- WHEN I navigate to login page
- THEN:
  - Automatically redirected to my dashboard (no need to login again)

---

#### Edge Cases

**E1: Rate Limiting (Too Many Failed Attempts)**

- After 5 failed login attempts within 15 minutes:
  - Account temporarily locked for 15 minutes
  - Error message: "Too many failed attempts. Please try again in 15 minutes."
  - Email sent to user: "Someone tried to login to your account multiple times."

**E2: Concurrent Logins (Same User, Multiple Devices)**

- Allow concurrent sessions (student can use phone + laptop)
- Track active sessions (max 5 devices)
- If 6th login, revoke oldest session

**E3: Password with Special Characters**

- Support all UTF-8 characters (including Indonesian: √©, √±, etc.)
- No restrictions on special chars (!@#$%^&\*)

**E4: Deactivated Account**

- If account is deactivated (admin action):
  - Login blocked
  - Error: "Your account has been deactivated. Please contact support."

**E5: Email Not Verified (Future Feature)**

- For MVP: Skip email verification
- For future: If email not verified, show warning banner after login

**E6: Network Error (API Unreachable)**

- Show error: "Unable to connect. Please check your internet connection."
- Retry button available

**E7: Session Expired (Token Invalid)**

- If token expired during login redirect:
  - Clear token from storage
  - Show message: "Session expired. Please login again."
  - Remain on login page

---

#### API Contract

**Endpoint:** `POST /api/auth/login`

**Request Body:**

```json
{
  "email": "student@example.com",
  "password": "SecurePass123!",
  "rememberMe": true
}
```

**Response (Success - 200 OK):**

```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "user_123",
      "email": "student@example.com",
      "name": "Sarah Ahmad",
      "role": "student",
      "avatar": "https://cdn.example.com/avatars/user_123.jpg",
      "createdAt": "2025-01-15T10:00:00Z"
    },
    "expiresIn": 2592000 // 30 days (if rememberMe), 86400 (24h otherwise)
  }
}
```

**Response (Error - 401 Unauthorized):**

```json
{
  "success": false,
  "error": {
    "code": "INVALID_CREDENTIALS",
    "message": "Invalid email or password"
  }
}
```

**Response (Error - 429 Too Many Requests):**

```json
{
  "success": false,
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "Too many failed attempts. Please try again in 15 minutes.",
    "retryAfter": 900 // seconds
  }
}
```

---

#### Dependencies

- **None** (foundation module)
- Email service (for "too many attempts" notification)

---

#### Test Scenarios

**TS1: Happy Path - Student Login**

1. Navigate to `/login`
2. Enter email: `student@test.com`, password: `Test1234!`
3. Click "Login"
4. Verify redirect to `/student/dashboard`
5. Verify toast: "Welcome back, Sarah!"

**TS2: Invalid Credentials**

1. Navigate to `/login`
2. Enter email: `student@test.com`, password: `WrongPassword`
3. Click "Login"
4. Verify error: "Invalid email or password"
5. Verify password field cleared

**TS3: Rate Limiting**

1. Attempt login with wrong password 5 times
2. On 6th attempt, verify error: "Too many failed attempts..."
3. Wait 15 minutes (or manually unlock in DB)
4. Verify login works again

**TS4: Remember Me**

1. Login with "Remember Me" checked
2. Close browser
3. Reopen browser, navigate to `/login`
4. Verify auto-redirect to dashboard

**TS5: Concurrent Sessions**

1. Login on Device A (Chrome)
2. Login on Device B (Firefox)
3. Verify both sessions active
4. Perform action on Device A ‚Üí success
5. Perform action on Device B ‚Üí success

---

#### UI/UX Notes

**Layout:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         [Logo]                      ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ      Welcome Back!                  ‚îÇ
‚îÇ      Login to continue              ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Email                              ‚îÇ
‚îÇ  [________________________]         ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Password          [üëÅ Show]        ‚îÇ
‚îÇ  [________________________]         ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚òê Remember Me                      ‚îÇ
‚îÇ               Forgot Password?      ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  [        Login        ]            ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Don't have an account? Sign Up     ‚îÇ
‚îÇ                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Colors (from globals.css):**

- Background: `GREYSCALE_0` (rgb(248, 250, 251))
- Input border: `GREYSCALE_300` (rgb(164, 172, 185))
- Input focus: `PRIMARY_200` (rgb(201, 130, 237))
- Button (primary): `PRIMARY_200` background, white text
- Error text: `ALERT_ERROR_100` (rgb(223, 28, 65))
- Success toast: `ALERT_SUCCESS_100` (rgb(64, 196, 170))

**Accessibility:**

- Labels associated with inputs (htmlFor)
- Tab order: Email ‚Üí Password ‚Üí Remember Me ‚Üí Login
- Enter key submits form
- Focus states visible (keyboard navigation)
- ARIA labels: `aria-label="Email input"`, `aria-describedby="email-error"`

---

#### Security Considerations

**S1: Password Transmission**

- ALWAYS use HTTPS (never HTTP)
- Password sent in request body (not URL)
- TLS 1.2+ encryption

**S2: Password Storage (Backend)**

- NEVER store plaintext passwords
- Use bcrypt (salt rounds: 10-12)
- Hash example: `$2b$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy`

**S3: JWT Token Security**

- Token includes: user ID, role, expiry
- Signed with secret key (HS256 algorithm)
- httpOnly cookie (preferred) OR localStorage (convenient, less secure)
- Short expiry for regular sessions (24h)
- Long expiry for "Remember Me" (30 days)

**S4: Rate Limiting**

- Max 5 failed attempts per email per 15 minutes
- Track by IP address + email (prevent distributed attacks)
- Use Redis for fast rate limit checks

**S5: SQL Injection Prevention**

- Use parameterized queries (Prisma/TypeORM automatically does this)
- Validate email format (regex)
- Sanitize all inputs

**S6: XSS Prevention**

- Escape user inputs before rendering
- Use React (automatically escapes by default)
- Content Security Policy (CSP) headers

**S7: CSRF Prevention**

- CSRF token for forms (if using cookies)
- SameSite cookie attribute: `SameSite=Strict`
- Origin/Referer header validation

---

---

### Story 1.1.2: User Logout

**Story Points:** 2  
**Priority:** üî¥ Critical  
**Sprint:** Sprint 1

#### User Story

```
AS A logged-in user
I WANT TO logout from my account
SO THAT I can securely end my session and prevent unauthorized access
```

#### Acceptance Criteria

**AC1: Logout Button Availability**

- GIVEN I am logged in
- WHEN I view the navigation menu (desktop) or hamburger menu (mobile)
- THEN I should see a "Logout" button/link
  - Desktop: In user dropdown menu (top-right, click avatar ‚Üí "Logout")
  - Mobile: In hamburger menu, bottom section

**AC2: Logout Action (Success)**

- GIVEN I click "Logout" button
- WHEN the logout process completes
- THEN:
  - JWT token removed from localStorage/cookies
  - User state cleared from Zustand store
  - All cached data cleared (React Query cache)
  - Redirected to `/login` page
  - Success toast: "You have been logged out successfully"

**AC3: Logout Confirmation (Optional - Prevent Accidental Logout)**

- GIVEN I click "Logout" button
- WHEN the button is clicked
- THEN:
  - Show confirmation modal: "Are you sure you want to logout?"
  - "Cancel" button ‚Üí closes modal, remains logged in
  - "Logout" button ‚Üí proceeds with logout (AC2)

**AC4: Post-Logout Navigation (Protected Routes)**

- GIVEN I have logged out
- WHEN I try to navigate to a protected route (e.g., `/student/dashboard`)
- THEN:
  - Redirected to `/login`
  - Error message: "Please login to access this page"

**AC5: Auto-Logout (Session Expired)**

- GIVEN my JWT token has expired
- WHEN I perform any action (API call)
- THEN:
  - API returns 401 Unauthorized
  - Automatically logged out (same as AC2)
  - Redirect to `/login`
  - Message: "Your session has expired. Please login again."

---

#### Edge Cases

**E1: Logout During API Call**

- If API call in progress when logout clicked:
  - Cancel pending requests (AbortController)
  - Proceed with logout

**E2: Network Error During Logout**

- Logout should work offline (client-side only for MVP)
- For future: Call `POST /api/auth/logout` to invalidate token server-side

**E3: Multiple Tabs Open**

- If user logs out in Tab A:
  - Tab B should also detect logout (use localStorage event listener)
  - All tabs redirect to login

**E4: Logout from Expired Session**

- If session already expired, don't show error
- Just redirect to login silently

---

#### API Contract

**Endpoint:** `POST /api/auth/logout` (Optional for MVP, recommended for production)

**Request Headers:**

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Response (Success - 200 OK):**

```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

**For MVP:** Client-side logout only (clear token, no API call)

---

#### Test Scenarios

**TS1: Happy Path - Logout**

1. Login as student
2. Navigate to dashboard
3. Click avatar ‚Üí "Logout"
4. Verify redirect to `/login`
5. Verify token removed from localStorage
6. Try navigating to `/student/dashboard` ‚Üí redirected to `/login`

**TS2: Logout Across Multiple Tabs**

1. Login, open 2 tabs (Tab A, Tab B)
2. In Tab A, click "Logout"
3. Verify Tab B also logs out (detects localStorage change)
4. Both tabs show login page

**TS3: Session Expiry During Activity**

1. Login with short-lived token (5 min for testing)
2. Wait 5+ minutes
3. Perform action (e.g., click on a course)
4. Verify auto-logout
5. Verify message: "Your session has expired..."

---

#### UI/UX Notes

**Logout Button Location:**

- Desktop: User dropdown (avatar click) ‚Üí "Logout" at bottom
- Mobile: Hamburger menu ‚Üí "Logout" in red text at bottom

**Confirmation Modal (Optional):**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Logout?                       [X]  ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Are you sure you want to logout?  ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  [  Cancel  ]    [  Logout  ]      ‚îÇ
‚îÇ   (secondary)     (danger/red)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

---

### Story 1.1.3: Session Management (JWT)

**Story Points:** 8  
**Priority:** üî¥ Critical  
**Sprint:** Sprint 1-2

#### User Story

```
AS A system
I WANT TO manage user sessions securely using JWT tokens
SO THAT users can maintain authenticated state across requests without re-logging in
```

#### Acceptance Criteria

**AC1: JWT Token Generation (on Login)**

- GIVEN a user successfully logs in
- WHEN JWT token is generated (backend)
- THEN token should contain:
  - Payload: `{ userId, email, role, iat, exp }`
  - Algorithm: HS256 (HMAC SHA-256)
  - Expiry: 24 hours (default), 30 days (if "Remember Me")
  - Signed with secret key (from environment variable)

**AC2: JWT Token Storage (Frontend)**

- GIVEN a JWT token is received
- WHEN storing the token
- THEN:
  - **Option A (Recommended):** httpOnly cookie (more secure, XSS protection)
  - **Option B (MVP):** localStorage (easier to implement, less secure)
  - Token key: `lms_auth_token`

**AC3: JWT Token Validation (on Every Request)**

- GIVEN a user makes an authenticated API request
- WHEN the request is sent
- THEN:
  - Token sent in `Authorization: Bearer <token>` header
  - Backend validates token (signature, expiry)
  - If valid ‚Üí proceed with request
  - If invalid/expired ‚Üí return 401 Unauthorized

**AC4: Token Expiry Handling**

- GIVEN a token has expired
- WHEN user makes a request
- THEN:
  - Backend returns 401 Unauthorized
  - Frontend intercepts 401 response (Axios interceptor)
  - Auto-logout user
  - Redirect to login with message: "Session expired"

**AC5: Token Refresh (Optional for MVP, Recommended for Production)**

- GIVEN a token is about to expire (within 1 hour)
- WHEN user is active on the platform
- THEN:
  - Frontend calls `POST /api/auth/refresh` with current token
  - Backend issues new token (extend session)
  - Frontend replaces old token with new token
  - User remains logged in (seamless)

**AC6: Session Persistence (Page Refresh)**

- GIVEN a user is logged in
- WHEN the page is refreshed (F5)
- THEN:
  - Token retrieved from localStorage/cookie
  - User state restored from token (decode JWT payload)
  - User remains logged in
  - Dashboard loads normally

---

#### Edge Cases

**E1: Token Tampered (Invalid Signature)**

- If token signature is invalid:
  - Backend rejects request (401)
  - Auto-logout user
  - Message: "Invalid session. Please login again."

**E2: Token Expired Mid-Session**

- If token expires while user is actively using the app:
  - Next API call ‚Üí 401
  - Auto-logout (graceful)
  - Save any unsaved work (show "Session expired, data saved locally")

**E3: Clock Skew (Server/Client Time Difference)**

- Use server time for expiry checks (backend)
- Allow 5-minute grace period (clock skew tolerance)

**E4: Token Stolen (Security Breach)**

- Implement token revocation (blacklist in Redis)
- On logout, add token to blacklist
- Future: Detect unusual activity (IP change, device change)

---

#### API Contract

**Token Payload (JWT):**

```json
{
  "userId": "user_123",
  "email": "student@example.com",
  "role": "student",
  "iat": 1735689600, // Issued At (Unix timestamp)
  "exp": 1735776000 // Expiry (Unix timestamp, 24h later)
}
```

**Token in Request Header:**

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJ1c2VyXzEyMyIsImVtYWlsIjoic3R1ZGVudEBleGFtcGxlLmNvbSIsInJvbGUiOiJzdHVkZW50IiwiaWF0IjoxNzM1Njg5NjAwLCJleHAiOjE3MzU3NzYwMDB9.signature
```

**Refresh Token Endpoint (Optional):**

**Endpoint:** `POST /api/auth/refresh`

**Request Headers:**

```
Authorization: Bearer <current_token>
```

**Response (Success - 200 OK):**

```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // New token
    "expiresIn": 86400 // 24 hours
  }
}
```

---

#### Dependencies

- Backend JWT library (e.g., `jsonwebtoken` for Node.js)
- Frontend Axios interceptor (for 401 handling)
- Zustand store (for user state)

---

#### Test Scenarios

**TS1: Token Valid - Authenticated Request**

1. Login as student
2. Make API call (e.g., fetch courses)
3. Verify token sent in `Authorization` header
4. Verify request succeeds (200 OK)

**TS2: Token Expired - Auto-Logout**

1. Login with short-lived token (1 min for testing)
2. Wait 2 minutes
3. Make API call
4. Verify 401 response
5. Verify auto-logout & redirect to login

**TS3: Page Refresh - Session Persists**

1. Login as student
2. Navigate to dashboard
3. Press F5 (refresh page)
4. Verify user remains logged in
5. Verify dashboard loads normally

**TS4: Tampered Token - Rejected**

1. Login, get token
2. Modify token payload manually (change userId)
3. Make API call with modified token
4. Verify 401 response (invalid signature)

---

#### Security Considerations

**S1: Secret Key Management**

- Store JWT secret in environment variable (`.env`)
- Use strong secret (32+ random characters)
- Never commit secret to Git
- Rotate secret periodically (invalidates all tokens)

**S2: Token Expiry Strategy**

- Short expiry (24h) for regular sessions (reduce risk if stolen)
- Long expiry (30 days) only if "Remember Me" (user accepts risk)
- Use refresh tokens for long-lived sessions (recommended)

**S3: httpOnly Cookies vs localStorage**

- **httpOnly Cookie:** More secure (XSS protection), backend sets cookie
- **localStorage:** Easier for MVP, vulnerable to XSS attacks
- Recommendation: Use httpOnly for production

**S4: Token Revocation**

- Implement blacklist (Redis) for logout
- On logout, add token to blacklist
- Check blacklist on every request (performance: Redis is fast)

---

---

### Story 1.1.4: Role-Based Access Control (RBAC)

**Story Points:** 8  
**Priority:** üî¥ Critical  
**Sprint:** Sprint 2

#### User Story

```
AS A system
I WANT TO enforce role-based permissions
SO THAT users can only access features appropriate for their role (Super Admin/Staff/Instructor/Student)
```

#### Acceptance Criteria

**AC1: Role Definition**

- System supports 4 roles:
  - **Student:** Access learning content, assignments, progress, gamification
  - **Instructor:** Create courses, manage assigned classes, grade assignments
  - **Staff:** Create classes, enroll students, assign instructors, track payments
  - **Super Admin:** Full system access, create staff/instructor accounts, override everything

**AC2: Frontend Route Protection**

- GIVEN a user with role X
- WHEN they try to access a route for role Y
- THEN:
  - If unauthorized ‚Üí redirect to their own dashboard
  - Show error: "You don't have permission to access this page"

**Routes by Role:**

- **Student:**
  - `/student/*` ‚úÖ (dashboard, learning)
  - `/courses/*` ‚úÖ (learning interface)
  - `/instructor/*` ‚ùå
  - `/staff/*` ‚ùå
  - `/super-admin/*` ‚ùå

- **Instructor:**
  - `/instructor/*` ‚úÖ (courses, classes, grading)
  - `/courses/*` ‚úÖ (view catalog, read-only)
  - `/student/*` ‚ùå
  - `/staff/*` ‚ùå
  - `/super-admin/*` ‚ùå

- **Staff:**
  - `/staff/*` ‚úÖ (enrollment, class management, payments)
  - `/courses/*` ‚úÖ (view catalog, read-only)
  - `/instructor/*` ‚ùå
  - `/student/*` ‚ùå
  - `/super-admin/*` ‚ùå

- **Super Admin:**
  - `/super-admin/*` ‚úÖ (full system access)
  - `/staff/*` ‚úÖ (can view staff operations)
  - `/instructor/*` ‚úÖ (can view teaching tools)
  - `/courses/*` ‚úÖ (can manage courses)
  - Note: Super Admin has access to ALL routes for troubleshooting

**AC3: Backend API Authorization**

- GIVEN a user makes an API request
- WHEN the request is processed
- THEN:
  - Backend checks user role (from JWT token)
  - If role authorized ‚Üí proceed
  - If role unauthorized ‚Üí return 403 Forbidden

**Example:**

- `GET /api/super-admin/users` ‚Üí Only Super Admin
- `POST /api/staff/classes` ‚Üí Staff + Super Admin
- `POST /api/staff/enrollments` ‚Üí Staff + Super Admin
- `POST /api/courses` ‚Üí Instructor + Super Admin
- `POST /api/classes/:id/unlock-lesson` ‚Üí Instructor (of that class) + Super Admin
- `GET /api/student/courses/:id` ‚Üí Student (enrolled) + Super Admin

**AC4: Component-Level Permissions (UI)**

- GIVEN a user is viewing a page
- WHEN the page renders
- THEN:
  - Only show UI elements user has permission to use
  - Example: Student dashboard should NOT show "Create Class" button

**AC5: Role-Based Navigation**

- GIVEN a user logs in
- WHEN they are redirected
- THEN:
  - Student ‚Üí `/student/dashboard`
  - Instructor ‚Üí `/instructor/dashboard`
  - Staff ‚Üí `/staff/dashboard`
  - Super Admin ‚Üí `/super-admin/dashboard`

**AC6: Multi-Role Support (Future - Out of MVP Scope)**

- For MVP: Each user has ONE role
- For future: User can have multiple roles (e.g., Admin + Instructor)
  - Show role switcher in UI
  - User selects active role

---

#### Edge Cases

**E1: User Role Changed Mid-Session**

- If admin changes user role while user is logged in:
  - User's current session remains valid (old role)
  - On next login, new role takes effect
  - Future: Implement real-time role update (WebSocket)

**E2: Direct URL Access (Bypass Frontend)**

- If user tries to access `/instructor/dashboard` by typing URL:
  - Frontend checks role, redirects if unauthorized
  - Backend still validates (defense in depth)

**E3: API Called Directly (Postman, curl)**

- Even if frontend bypassed, backend ALWAYS checks role
- 403 Forbidden if unauthorized

---

#### API Contract

**Role Check (Backend Middleware):**

```typescript
// Example: Instructor-only endpoint
app.post(
  '/api/instructor/classes/:id/unlock-lesson',
  authenticate, // Verify JWT
  authorize(['instructor']), // Check role
  unlockLessonHandler,
);

// Middleware: authorize
function authorize(allowedRoles: string[]) {
  return (req, res, next) => {
    const userRole = req.user.role; // From JWT token
    if (!allowedRoles.includes(userRole)) {
      return res.status(403).json({
        success: false,
        error: {
          code: 'FORBIDDEN',
          message: 'You do not have permission to perform this action',
        },
      });
    }
    next();
  };
}
```

**Response (Error - 403 Forbidden):**

```json
{
  "success": false,
  "error": {
    "code": "FORBIDDEN",
    "message": "You do not have permission to perform this action"
  }
}
```

---

#### Dependencies

- Story 1.1.3 (Session Management - JWT contains role)
- Frontend routing library (Next.js App Router)
- Backend authorization middleware

---

#### Test Scenarios

**TS1: Student Accesses Student Route**

1. Login as student
2. Navigate to `/student/dashboard`
3. Verify access granted

**TS2: Student Tries to Access Instructor Route**

1. Login as student
2. Manually navigate to `/instructor/dashboard`
3. Verify redirected to `/student/dashboard`
4. Verify error: "You don't have permission..."

**TS3: Instructor Calls Student-Only API**

1. Login as instructor, get token
2. Call `GET /api/student/courses/:id` (student-only endpoint)
3. Verify 403 Forbidden response

**TS4: Admin Full Access**

1. Login as admin
2. Navigate to `/admin/users` ‚Üí success
3. Navigate to `/admin/analytics` ‚Üí success
4. Call admin-only APIs ‚Üí success

---

#### Security Considerations

**S1: Defense in Depth**

- NEVER rely solely on frontend checks (can be bypassed)
- ALWAYS validate role in backend (every API call)

**S2: Least Privilege Principle**

- Users only have access they need (no more)
- Instructor can only manage THEIR classes (not all classes)
- Student can only view THEIR courses (not all students' data)

**S3: Role in JWT Payload**

- Role stored in JWT token (can't be modified without invalidating signature)
- Backend trusts role from JWT (after signature validation)

---

---

### Story 1.1.5: Forgot Password Flow

**Story Points:** 5  
**Priority:** üî¥ Critical  
**Sprint:** Sprint 2

#### User Story

```
AS A user who forgot my password
I WANT TO request a password reset link
SO THAT I can regain access to my account
```

#### Acceptance Criteria

**AC1: Forgot Password Link (on Login Page)**

- GIVEN I am on the login page
- WHEN I click "Forgot Password?" link
- THEN I am redirected to `/forgot-password` page

**AC2: Forgot Password Form**

- GIVEN I am on `/forgot-password` page
- WHEN the page loads
- THEN I should see:
  - "Reset Your Password" heading
  - Email input field
  - "Send Reset Link" button
  - "Back to Login" link

**AC3: Submit Email (User Exists)**

- GIVEN I enter a valid email (user exists in system)
- WHEN I click "Send Reset Link"
- THEN:
  - API call to `POST /api/auth/forgot-password`
  - Success message: "If an account exists with this email, you will receive a password reset link shortly."
  - Reset email sent to user's email
  - Email contains: reset link with token (valid for 1 hour)

**AC4: Submit Email (User Does Not Exist)**

- GIVEN I enter an email that doesn't exist
- WHEN I click "Send Reset Link"
- THEN:
  - Same success message (security: don't reveal user existence)
  - No email sent (silently fail on backend)

**AC5: Email Content (Reset Link)**

- GIVEN a reset email is sent
- WHEN user receives the email
- THEN email should contain:
  - Subject: "Reset Your Password - LMS Baby Owl"
  - Greeting: "Hi [Name],"
  - Message: "You requested to reset your password. Click the link below to reset:"
  - Reset link: `https://lms.babyowl.com/reset-password?token=<token>`
  - Link expiry note: "This link will expire in 1 hour"
  - Security note: "If you didn't request this, please ignore this email."
  - Support link

**AC6: Rate Limiting (Prevent Abuse)**

- GIVEN I have requested password reset
- WHEN I try to request again within 5 minutes
- THEN:
  - Show error: "Please wait 5 minutes before requesting another reset link"
  - Don't send email (prevent spam)

---

#### Edge Cases

**E1: Multiple Reset Requests**

- If user requests reset 3 times:
  - Each request generates new token
  - Previous tokens invalidated (only latest token valid)

**E2: Email Service Down**

- If email fails to send:
  - Log error (backend)
  - Still show success message to user (don't reveal system status)
  - Retry email send (background job)

**E3: Invalid Email Format**

- If email format invalid:
  - Show validation error: "Please enter a valid email"
  - Don't make API call

---

#### API Contract

**Endpoint:** `POST /api/auth/forgot-password`

**Request Body:**

```json
{
  "email": "student@example.com"
}
```

**Response (Success - 200 OK):**

```json
{
  "success": true,
  "message": "If an account exists with this email, you will receive a password reset link shortly."
}
```

**Backend Logic:**

1. Check if user exists with email
2. If yes:
   - Generate reset token (random 32-char string)
   - Hash token, store in `password_resets` table with expiry (1 hour)
   - Send email with reset link
3. If no:
   - Silently do nothing (security: don't reveal user existence)
4. Always return success response

---

#### Dependencies

- Story 1.1.6 (Reset Password - token validation)
- Email service (Resend/SendGrid/AWS SES)
- Database table: `password_resets`

---

#### Test Scenarios

**TS1: Happy Path - Forgot Password**

1. Navigate to `/login`
2. Click "Forgot Password?"
3. Enter email: `student@test.com`
4. Click "Send Reset Link"
5. Verify success message
6. Check email inbox
7. Verify email received with reset link

**TS2: User Does Not Exist**

1. On `/forgot-password` page
2. Enter email: `nonexistent@test.com`
3. Click "Send Reset Link"
4. Verify same success message (don't reveal user doesn't exist)
5. Check email inbox ‚Üí no email

**TS3: Rate Limiting**

1. Request reset for `student@test.com`
2. Immediately request again
3. Verify error: "Please wait 5 minutes..."

---

#### UI/UX Notes

**Forgot Password Page Layout:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         [Logo]                      ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ      Reset Your Password            ‚îÇ
‚îÇ      Enter your email to receive    ‚îÇ
‚îÇ      a reset link                   ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Email                              ‚îÇ
‚îÇ  [________________________]         ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  [   Send Reset Link   ]            ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚Üê Back to Login                    ‚îÇ
‚îÇ                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

---

### Story 1.1.6: Reset Password (Token-Based)

**Story Points:** 5  
**Priority:** üî¥ Critical  
**Sprint:** Sprint 2

#### User Story

```
AS A user who requested password reset
I WANT TO set a new password using the reset link
SO THAT I can login with my new password
```

#### Acceptance Criteria

**AC1: Access Reset Page (Valid Token)**

- GIVEN I click the reset link from email
- WHEN I navigate to `/reset-password?token=<token>`
- THEN:
  - API validates token (call `GET /api/auth/validate-reset-token?token=<token>`)
  - If valid ‚Üí show reset password form
  - If invalid/expired ‚Üí show error page

**AC2: Reset Password Form**

- GIVEN I am on reset password page (valid token)
- WHEN the page loads
- THEN I should see:
  - "Set New Password" heading
  - "New Password" input field (password type, masked)
  - "Confirm Password" input field (password type, masked)
  - Password strength indicator (Weak/Medium/Strong)
  - "Reset Password" button
  - Password requirements:
    - At least 8 characters
    - At least 1 uppercase letter
    - At least 1 lowercase letter
    - At least 1 number
    - At least 1 special character (!@#$%^&\*)

**AC3: Submit New Password (Valid)**

- GIVEN I enter valid new password (meets requirements)
- WHEN I click "Reset Password"
- THEN:
  - API call to `POST /api/auth/reset-password`
  - Password updated in database (hashed with bcrypt)
  - Reset token invalidated (deleted from `password_resets`)
  - Success message: "Password reset successful!"
  - Redirected to `/login` after 3 seconds
  - Optional: Auto-login (generate JWT, redirect to dashboard)

**AC4: Password Mismatch**

- GIVEN new password and confirm password don't match
- WHEN I click "Reset Password"
- THEN:
  - Show error: "Passwords do not match"
  - Don't make API call

**AC5: Token Expired**

- GIVEN the reset token has expired (>1 hour old)
- WHEN I try to access reset page or submit form
- THEN:
  - Show error: "Reset link has expired. Please request a new one."
  - "Request New Link" button ‚Üí redirects to `/forgot-password`

**AC6: Token Already Used**

- GIVEN the reset token has already been used
- WHEN I try to use the same link again
- THEN:
  - Show error: "This reset link has already been used."
  - "Request New Link" button

---

#### Edge Cases

**E1: Token Invalid (Tampered)**

- If token format invalid or doesn't exist:
  - Show error: "Invalid reset link"

**E2: Password Too Simple (Weak)**

- If password is "password123":
  - Show warning: "This password is too common. Choose a stronger password."
  - Still allow (don't block, just warn)

**E3: Same as Old Password**

- If new password same as old password:
  - Allow (no restriction for MVP)
  - Future: Enforce "must be different from last 3 passwords"

---

#### API Contract

**Endpoint 1:** `GET /api/auth/validate-reset-token?token=<token>`

**Response (Valid - 200 OK):**

```json
{
  "success": true,
  "data": {
    "valid": true,
    "email": "student@example.com" // Show email on reset page
  }
}
```

**Response (Invalid/Expired - 400 Bad Request):**

```json
{
  "success": false,
  "error": {
    "code": "INVALID_TOKEN",
    "message": "Reset link is invalid or has expired"
  }
}
```

---

**Endpoint 2:** `POST /api/auth/reset-password`

**Request Body:**

```json
{
  "token": "abc123...",
  "newPassword": "NewSecurePass123!"
}
```

**Response (Success - 200 OK):**

```json
{
  "success": true,
  "message": "Password reset successful",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // Optional: Auto-login
    "user": {
      /* user object */
    }
  }
}
```

**Response (Error - 400 Bad Request):**

```json
{
  "success": false,
  "error": {
    "code": "WEAK_PASSWORD",
    "message": "Password does not meet requirements"
  }
}
```

---

#### Dependencies

- Story 1.1.5 (Forgot Password - token generation)
- Database table: `password_resets`

---

#### Test Scenarios

**TS1: Happy Path - Reset Password**

1. Request forgot password (Story 1.1.5)
2. Get reset link from email
3. Click link ‚Üí navigate to `/reset-password?token=...`
4. Enter new password: `NewPass123!`
5. Confirm password: `NewPass123!`
6. Click "Reset Password"
7. Verify success message
8. Verify redirected to `/login`
9. Login with new password ‚Üí success

**TS2: Token Expired**

1. Request forgot password
2. Wait 2 hours (or manually expire token in DB)
3. Click reset link
4. Verify error: "Reset link has expired"

**TS3: Passwords Don't Match**

1. On reset page (valid token)
2. New password: `Pass123!`
3. Confirm password: `Pass456!` (different)
4. Click "Reset Password"
5. Verify error: "Passwords do not match"

**TS4: Weak Password**

1. On reset page
2. Enter password: `12345678` (no uppercase, no special char)
3. Verify password strength: "Weak"
4. Try to submit ‚Üí show validation error

---

#### Security Considerations

**S1: Token Storage**

- Store hashed token in database (not plaintext)
- Use bcrypt or SHA-256 for hashing

**S2: Token Expiry**

- 1 hour expiry (balance between security and usability)
- Automatically delete expired tokens (cron job)

**S3: Single Use Token**

- After successful reset, delete token immediately
- Prevent token reuse

**S4: Password Hashing**

- Hash new password with bcrypt (same as registration)
- Salt rounds: 10-12

---

---

### Story 1.1.7: Change Password (Authenticated User)

**Story Points:** 3  
**Priority:** üî¥ Critical  
**Sprint:** Sprint 2

#### User Story

```
AS A logged-in user
I WANT TO change my current password
SO THAT I can update my password for security reasons
```

#### Acceptance Criteria

**AC1: Access Change Password Page**

- GIVEN I am logged in
- WHEN I navigate to Settings ‚Üí Security (or Profile ‚Üí Change Password)
- THEN I see "Change Password" form

**AC2: Change Password Form**

- Form contains:
  - "Current Password" input field
  - "New Password" input field
  - "Confirm New Password" input field
  - Password strength indicator
  - "Change Password" button
  - "Cancel" button

**AC3: Submit Change Password (Success)**

- GIVEN I enter correct current password + valid new password
- WHEN I click "Change Password"
- THEN:
  - API call to `PUT /api/auth/change-password`
  - Verify current password matches (backend)
  - Update password (hash with bcrypt)
  - Success toast: "Password changed successfully"
  - Optional: Logout all other sessions (force re-login on other devices)
  - Email notification: "Your password was changed"

**AC4: Incorrect Current Password**

- GIVEN I enter wrong current password
- WHEN I submit form
- THEN:
  - Show error: "Current password is incorrect"

**AC5: New Password Same as Current**

- GIVEN new password is same as current password
- WHEN I submit form
- THEN:
  - Show warning: "New password must be different from current password"

---

#### API Contract

**Endpoint:** `PUT /api/auth/change-password`

**Request Body:**

```json
{
  "currentPassword": "OldPass123!",
  "newPassword": "NewPass456!"
}
```

**Response (Success - 200 OK):**

```json
{
  "success": true,
  "message": "Password changed successfully"
}
```

---

#### Test Scenarios

**TS1: Happy Path - Change Password**

1. Login as student
2. Navigate to Settings ‚Üí Security
3. Enter current password: `OldPass123!`
4. Enter new password: `NewPass456!`
5. Confirm new password: `NewPass456!`
6. Click "Change Password"
7. Verify success toast
8. Logout, login with new password ‚Üí success

---

---

### Story 1.1.8: Security Features (Rate Limiting, CSRF)

**Story Points:** 6  
**Priority:** üü† High  
**Sprint:** Sprint 2

#### User Story

```
AS A system
I WANT TO implement security best practices
SO THAT the platform is protected from common attacks
```

#### Acceptance Criteria

**AC1: Rate Limiting (Login Endpoint)**

- Max 5 failed login attempts per IP per 15 minutes
- After limit reached, return 429 Too Many Requests
- Use Redis for tracking (fast, distributed)

**AC2: CSRF Protection**

- CSRF token for forms (if using cookies)
- SameSite=Strict cookie attribute

**AC3: Password Requirements Enforcement**

- Min 8 characters
- At least 1 uppercase, 1 lowercase, 1 number, 1 special char

**AC4: Security Headers**

- `X-Frame-Options: DENY` (prevent clickjacking)
- `X-Content-Type-Options: nosniff`
- `Strict-Transport-Security: max-age=31536000` (HSTS)

---

---

## üìä Module Summary

### Total Story Points: 42

| Story | Title                     | Points |
| ----- | ------------------------- | ------ |
| 1.1.1 | User Login                | 5      |
| 1.1.2 | User Logout               | 2      |
| 1.1.3 | Session Management (JWT)  | 8      |
| 1.1.4 | Role-Based Access Control | 8      |
| 1.1.5 | Forgot Password Flow      | 5      |
| 1.1.6 | Reset Password            | 5      |
| 1.1.7 | Change Password           | 3      |
| 1.1.8 | Security Features         | 6      |

---

## ‚úÖ Module Completion Checklist

Module is complete when:

- [ ] All 8 user stories implemented
- [ ] All acceptance criteria met
- [ ] All edge cases handled
- [ ] API contracts implemented (backend)
- [ ] Frontend components built
- [ ] Unit tests (>80% coverage)
- [ ] Integration tests (login ‚Üí logout flow)
- [ ] Security audit passed
- [ ] Performance benchmarks met (<500ms API response)
- [ ] Accessibility tested (WCAG AA)
- [ ] Cross-browser tested (Chrome, Safari, Firefox)
- [ ] Mobile responsive tested
- [ ] Documentation complete

---

**End of Module 1: Authentication & Security**

_Next Module: [Module 2: User Registration & Onboarding ‚Üí](../module-02-user-registration/1.2-user-registration-onboarding.md)_
